# Performance Threshold Checker

A standalone Java application that validates JMeter performance test results against defined thresholds.

## Overview

The Threshold Checker reads JMeter's `statistics.json` file and checks if performance metrics meet predefined thresholds. It's designed to integrate seamlessly into CI/CD pipelines to fail builds when performance regresses.

## How It Works

1. Reads `statistics.json` generated by JMeter's dashboard report
2. Extracts metrics from the "Total" transaction
3. Compares against configured thresholds
4. Prints a summary with pass/fail status
5. Exits with code 0 (pass) or 1 (fail)

## Default Thresholds

| Metric | Threshold | Description |
|--------|-----------|-------------|
| Max Median Response Time | 1000ms | Median response time must be under 1 second |
| Max Error Rate | 1.0% | Error rate must be under 1% |
| Min Throughput | 25.0 req/sec | Throughput must be at least 25 requests/second |
| Max P90 Response Time | 3300ms | 90th percentile must be under 3 seconds |

## Building

```bash
mvn clean package
```

This creates an executable JAR: `target/threshold-checker.jar`

## Usage

### Basic Usage

```bash
java -jar threshold-checker.jar <path-to-statistics.json>
```

Example:
```bash
java -jar target/threshold-checker.jar ../../perf-results/2025-01-11-143022/report/statistics.json
```

### With Custom Thresholds (Properties File)

**Recommended for CI/CD:**

```bash
java -jar threshold-checker.jar <path-to-statistics.json> <path-to-thresholds.properties>
```

Example:
```bash
java -jar target/threshold-checker.jar ../../perf-results/2025-01-11-143022/report/statistics.json ../../jmeter/thresholds.properties
```

The properties file should contain:
```properties
perf.max.median.response.time=800
perf.max.error.rate=0.5
perf.min.throughput=30.0
perf.max.p90.response.time=2500
```

### With Custom Thresholds (Environment Variables)

**Fallback option when properties file not provided:**

```bash
export PERF_MAX_MEDIAN_RESPONSE_TIME="800"
export PERF_MAX_ERROR_RATE="0.5"
export PERF_MIN_THROUGHPUT="30.0"
export PERF_MAX_P90_RESPONSE_TIME="2500"

java -jar threshold-checker.jar <path-to-statistics.json>
```

### Configuration Priority

The threshold checker loads configuration in this priority order:

1. **Properties file** (if provided as second argument) - Highest priority
2. **Environment variables** (if properties file not provided) - Medium priority
3. **Hardcoded defaults** (if neither provided) - Lowest priority

This allows flexible configuration for different environments without modifying code.

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `PERF_MAX_MEDIAN_RESPONSE_TIME` | 1000 | Maximum allowed median response time (ms) |
| `PERF_MAX_ERROR_RATE` | 1.0 | Maximum allowed error rate (percentage) |
| `PERF_MIN_THROUGHPUT` | 25.0 | Minimum required throughput (req/sec) |
| `PERF_MAX_P90_RESPONSE_TIME` | 3300 | Maximum allowed 90th percentile response time (ms) |

### Properties File Keys

| Property Key | Env Variable Equivalent | Description |
|--------------|-------------------------|-------------|
| `perf.max.median.response.time` | `PERF_MAX_MEDIAN_RESPONSE_TIME` | Maximum allowed median response time (ms) |
| `perf.max.error.rate` | `PERF_MAX_ERROR_RATE` | Maximum allowed error rate (percentage) |
| `perf.min.throughput` | `PERF_MIN_THROUGHPUT` | Minimum required throughput (req/sec) |
| `perf.max.p90.response.time` | `PERF_MAX_P90_RESPONSE_TIME` | Maximum allowed 90th percentile response time (ms) |

## Output Examples

### Passing Tests

```
========== Performance Threshold Check ==========
Configuration:
  Max Median Response Time: 1000.0ms
  Max Error Rate: 1.0%
  Min Throughput: 25.0 req/sec
  Max P90 Response Time: 3300.0ms

Results:
✓ Error rate: 0.00% (threshold: 1.0%)
✓ Throughput: 28.89 req/sec (threshold: 25.0 req/sec)
✓ Median response time: 896.31ms (threshold: 1000.0ms)
✓ P90 response time: 3152.60ms (threshold: 3300.0ms)
=================================================

✅ All performance thresholds passed!
```

### Failing Tests

```
========== Performance Threshold Check ==========
Configuration:
  Max Median Response Time: 1000.0ms
  Max Error Rate: 1.0%
  Min Throughput: 25.0 req/sec
  Max P90 Response Time: 3300.0ms

Results:
✓ Error rate: 0.00% (threshold: 1.0%)
✗ Throughput: 15.23 req/sec (threshold: 25.0 req/sec) - BELOW by 39%
✗ Median response time: 2500.45ms (threshold: 1000.0ms) - EXCEEDED by 150%
✓ P90 response time: 2800.12ms (threshold: 33000.0ms)
=================================================

❌ Performance regression detected! 2 threshold(s) violated:
  - Throughput: 15.23 req/sec (threshold: 25.0 req/sec) - BELOW by 39%
  - Median response time: 2500.45ms (threshold: 1000.0ms) - EXCEEDED by 150%
```

## Exit Codes

| Code | Meaning |
|------|---------|
| 0 | All thresholds passed |
| 1 | One or more thresholds failed |
| 2 | Error (invalid arguments, file not found, parse error) |

## Integration with CI/CD

The threshold checker is automatically used in the GitHub Actions workflow with the properties file:

```yaml
- name: Check performance thresholds
  run: |
    java -jar perf-checker/target/threshold-checker.jar \
      perf-results/<timestamp>/report/statistics.json \
      jmeter/thresholds.properties
```

The workflow uses `jmeter/thresholds.properties` to configure thresholds. This file is version-controlled, allowing threshold adjustments without modifying the workflow or code.

If thresholds are exceeded, the workflow fails and prevents performance regressions from being deployed.

## Understanding JMeter Metrics

The checker uses these fields from JMeter's `statistics.json`:

| JSON Field | Checker Uses | Description |
|------------|--------------|-------------|
| `medianResTime` | Median Response Time | Median response time across all samples |
| `errorPct` | Error Rate | Percentage of failed samples (0-100) |
| `throughput` | Throughput | Requests per second |
| `pct1ResTime` | P90 Response Time | 90th percentile response time |

## Customizing Thresholds

### For Your Environment

Different environments may require different thresholds:

**Development/Testing:**
```bash
export PERF_MAX_MEDIAN_RESPONSE_TIME="1500"
export PERF_MAX_P90_RESPONSE_TIME="4000"
```

**Production-like:**
```bash
export PERF_MAX_MEDIAN_RESPONSE_TIME="500"
export PERF_MIN_THROUGHPUT="50.0"
export PERF_MAX_P90_RESPONSE_TIME="2000"
```

### Modifying Default Values

Edit `ThresholdChecker.java` constants:

```java
private static final double DEFAULT_MAX_MEDIAN_RESPONSE_TIME = 1000.0;
private static final double DEFAULT_MAX_ERROR_RATE = 1.0;
private static final double DEFAULT_MIN_THROUGHPUT = 25.0;
private static final double DEFAULT_MAX_P90_RESPONSE_TIME = 3000.0;
```

Then rebuild: `mvn clean package`

## Troubleshooting

### statistics.json not found

Ensure JMeter generated the dashboard report:
```bash
jmeter -n -t test.jmx -l results.jtl -e -o report/
```

The `-e -o report/` flags generate the dashboard and `statistics.json`.

### Invalid threshold values

Check environment variable format:
```bash
# Correct
export PERF_MAX_MEDIAN_RESPONSE_TIME="1000"

# Incorrect (quotes matter)
export PERF_MAX_MEDIAN_RESPONSE_TIME=1000ms
```

### Parse errors

Ensure the `statistics.json` is valid JSON. JMeter may fail to generate it if the test had no samples.

## Development

### Dependencies

- Java 25
- Gson 2.13.2 (for JSON parsing)

### Building from Source

```bash
mvn clean compile
mvn package
```

### Running Tests

```bash
# Test with a sample statistics.json
java -jar target/threshold-checker.jar path/to/statistics.json
```

## License

Same as the main Employee Management API project.
